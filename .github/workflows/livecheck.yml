name: brew livecheck

on:
    workflow_dispatch:
    schedule:
        - cron: "45 */3 * * *"

jobs:
    livecheck:
        runs-on: ubuntu-24.04
        permissions:
            contents: write
            pull-requests: write
        steps:
            - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

            - name: Set up Homebrew
              id: set-up-homebrew
              uses: Homebrew/actions/setup-homebrew@main
              with:
                  token: ${{ secrets.GH_TOKEN }}

            - name: Cache Homebrew Bundler RubyGems
              uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
              with:
                  path: ${{ steps.set-up-homebrew.outputs.gems-path }}
                  key: ubuntu-24.04-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
                  restore-keys: ubuntu-24.04-rubygems-

            - name: Run livecheck
              run: |
                  brew livecheck --tap="$GITHUB_REPOSITORY" --json > livecheck.json
                  jq -c '.[] | select(.status != "skipped") | select(.version.latest != .version.current)' livecheck.json

            - name: Configure Git user
              uses: Homebrew/actions/git-user-config@main
              with:
                  username: BrewTestBot

            - name: Bump outdated formulae
              run: |
                  jq -c '.[] | select(.status != "skipped") | select(.version.latest != .version.current)' livecheck.json | while read -r formula; do
                  name="$(echo "$formula" | jq -r .formula)"
                  current_ver="$(echo "$formula" | jq -r .version.current)"
                  new_ver="$(echo "$formula" | jq -r .version.latest)"
                  
                  # Special handling for 'bun' to archive the current version
                  if [[ "$name" == "bun" ]]; then
                    echo "Processing version archive for bun ${current_ver}..."
                    versioned_name="bun@${current_ver}"
                    versioned_file="Formula/${versioned_name}.rb"
                    
                    # Clean version string for class name (remove dots, hyphens)
                    class_suffix=$(echo "$current_ver" | tr -d '.-')
                    class_name="BunAT${class_suffix}"
                    
                    # Check if versioned file already exists
                    if [[ ! -f "$versioned_file" ]]; then
                      echo "Archiving current bun version to $versioned_file"
                      cp Formula/bun.rb "$versioned_file"
                      
                      # Update class name
                      sed -i "s/class Bun /class ${class_name} /" "$versioned_file"
                      
                      # Create branch and PR for the archived version
                      archive_branch="archive-bun-${current_ver}"
                      
                      # Only proceed if remote branch doesn't exist
                      if ! git ls-remote --heads origin "$archive_branch" | grep -q .; then
                        # Configure git if not already configured by action
                        git config user.name "BrewTestBot"
                        git config user.email "BrewTestBot@users.noreply.github.com"
                        
                        git checkout -b "$archive_branch"
                        git add "$versioned_file"
                        git commit -m "Add ${versioned_name} formula"
                        git push origin "$archive_branch"
                        
                        gh pr create \
                          --title "Add ${versioned_name} formula" \
                          --body "Archives bun version ${current_ver} as ${versioned_name}" \
                          --head "$archive_branch" \
                          --base main
                          
                        # Switch back to main (or detached head) for the bump
                        git checkout -
                      else
                        echo "Branch $archive_branch already exists, skipping archive PR"
                      fi
                    else
                      echo "$versioned_file already exists, skipping archive"
                    fi
                  fi
                  
                  # Skip if branch already exists remotely
                  if git ls-remote --heads origin "bump-${name}-${new_ver}" | grep -q .; then
                    echo "Skipping $name $new_ver - branch already exists"
                    continue
                  fi

                  brew bump-formula-pr \
                    --no-audit --no-browse --force \
                    --version="$new_ver" \
                    "amrkmn/bun/${name}"
                  done
              env:
                  HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GH_TOKEN }}
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
