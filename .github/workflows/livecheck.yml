name: brew livecheck

on:
    workflow_dispatch:
    schedule:
        - cron: "45 */3 * * *"

jobs:
    livecheck:
        runs-on: ubuntu-24.04
        permissions:
            contents: write
            pull-requests: write
        steps:
            - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

            - name: Set up Homebrew
              id: set-up-homebrew
              uses: Homebrew/actions/setup-homebrew@main
              with:
                  token: ${{ secrets.GH_TOKEN }}

            - name: Cache Homebrew Bundler RubyGems
              uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
              with:
                  path: ${{ steps.set-up-homebrew.outputs.gems-path }}
                  key: ubuntu-24.04-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
                  restore-keys: ubuntu-24.04-rubygems-

            - name: Run livecheck
              run: |
                  brew livecheck --tap="$GITHUB_REPOSITORY" --json > livecheck.json
                  jq -c '.[] | select(.status != "skipped") | select(.version.latest != .version.current)' livecheck.json

            - name: Configure Git user
              uses: Homebrew/actions/git-user-config@main
              with:
                  username: BrewTestBot

            - name: Create versioned formulae
              run: |
                  # Use the livecheck script to create versioned formulae
                  jq -c '.[] | select(.status != "skipped") | select(.version.latest != .version.current)' livecheck.json | .github/scripts/livecheck.sh
              
            - name: Create PRs for versioned formulae
              run: |
                  git config --global user.name "BrewTestBot"
                  git config --global user.email "brew-test-bot@users.noreply.github.com"
                  
                  for versioned_file in Formula/bun@*.rb; do
                      if [[ -f "$versioned_file" ]]; then
                          # Check if file has changes (untracked or modified)
                          if [[ -z $(git status --porcelain "$versioned_file") ]]; then
                              echo "No changes in $versioned_file, skipping"
                              continue
                          fi

                          version=$(basename "$versioned_file" .rb | sed 's/bun@//')
                          versioned_name="bun@${version}"
                          branch="add-${versioned_name}"
                          
                          # Check if PR/branch already exists
                          if ! git ls-remote --heads origin "$branch" | grep -q .; then
                              git checkout -b "$branch"
                              git add "$versioned_file"
                              git commit -m "Add ${versioned_name} formula"
                              git push -u origin "$branch"
                              
                              gh pr create \
                                --title "Add ${versioned_name} formula" \
                                --body "Adds versioned formula for bun ${version}" \
                                --head "$branch" \
                                --base main
                              
                              git checkout -
                          else
                              echo "Branch $branch already exists, skipping PR for $versioned_file"
                          fi
                      fi
                  done
              
            - name: Bump outdated formulae
              run: |
                  jq -c '.[] | select(.status != "skipped") | select(.version.latest != .version.current)' livecheck.json | while read -r formula; do
                  name="$(echo "$formula" | jq -r .formula)"
                  new_ver="$(echo "$formula" | jq -r .version.latest)"
                  
                  # Skip if branch already exists remotely
                  if git ls-remote --heads origin "bump-${name}-${new_ver}" | grep -q .; then
                    echo "Skipping $name $new_ver - branch already exists"
                    continue
                  fi

                  brew bump-formula-pr \
                    --no-audit --no-browse --force \
                    --version="$new_ver" \
                    "amrkmn/bun/${name}"
                  done
              env:
                  HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GH_TOKEN }}
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
